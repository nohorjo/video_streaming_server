<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Video Streaming Server</title>
      <link rel="stylesheet" href="style.css">
      <script src="http://muhammedhaque.co.uk/pages/data-api.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    </head>
    <body onkeydown="handleOnKeyDown(event)">
      <div id="app">
        <video
          v-bind:src="src"
          v-bind:class="{overscan: isTV}"
          controls
          autofocus
          playsinline
          autoplay
        >
          <track
            label="Track 1 - [English]"
            kind="subtitles"
            srclang="en"
            v-bind:src="src + '.vtt'"
            default
          />
        </video>
        <audio
          v-bind:src="src.replace(/[^\.]+$/, 'mp3')"
          autoplay
        ></audio>
      </div>
      <script>
        const user = localStorage.getItem('user');
        if (!user) {
          location.pathname = '/login';
        }

        const videoEl = () => document.querySelector('video');
        const audioEl = () => document.querySelector('audio');

        const app = new Vue({
          el: '#app',
          data: {
            src: location.hash.slice(1),
            isTV: navigator.userAgent.includes('Silk'),
          },
          mounted: () => {
            videoEl().addEventListener("loadedmetadata", () => {
              Data.get('videoTime/' + user + '/times/' + encodeURIComponent(location.hash.replace(/\.\w+$/, '')))
                .then(r => {
                  videoEl().currentTime = (r || 0) * videoEl().duration;
                });
            });
            let updateTimeout;
            videoEl().addEventListener("timeupdate", () => {
              if (!updateTimeout) {
                updateTimeout = setTimeout(() => updateTimeout = 0, 10000);
                updateTimeRemote();
              }
            });
            videoEl().addEventListener('pause', () => {
              updateTimeRemote();
              audioEl().pause();
            });
            videoEl().addEventListener('ended', () => {
              updateTimeRemote();
              const { hash } = location;
              const index = hash.lastIndexOf('/');
              location.href = `/?last=${encodeURIComponent(hash.slice(index + 1))}${hash.slice(0, index)}`;
            });
            videoEl().addEventListener("play", () => {
              audioEl().play();
            });
            videoEl().addEventListener("seeked", () => {
              audioEl().currentTime = videoEl().currentTime;
            });
          },
        });

        function handleOnKeyDown(event) {
          let preventDefault = true;
          switch(event.key) {
            case 'ArrowLeft':
              videoEl().currentTime -= 10;
              break;
            case 'ArrowRight':
              videoEl().currentTime += 10;
              break;
            case '0':
              videoEl().currentTime = 0;
              break;
            case 'm':
              videoEl().muted = !videoEl().muted;
              break;
            case 'f':
              if (document.fullscreenElement) {
                document.exitFullscreen();
              } else {
                videoEl().requestFullscreen();
              }
              break;
            default:
              console.log(event.key);
              preventDefault = false;
              break;
          }
          if (preventDefault) event.preventDefault();
        }
        function updateTimeRemote() {
          Data.set('videoTime/' + user + '/times/' + encodeURIComponent(location.hash.replace(/\.\w+$/, '')), videoEl().currentTime / videoEl().duration);
        }

      </script>
    </body>
  </html>
