<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Video Streaming Server</title>
      <link rel="stylesheet" href="style.css">
      <script src="https://muhammedhaque.co.uk/page/data-api.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
      <style>
        canvas { display: block; margin: 20px auto; background: #222; position: absolute; }
      </style>
    </head>
    <body onkeydown="handleOnKeyDown(event)">
      <div id="app" onmousemove="handleMouseMove()">
        <video
          v-if="!audioOnly"
          onclick="togglePlayback()"
          ondblclick="toggleFullScreen()"
          src="_audio_backgrounds/background.webm"
          playsinline
          autoplay
          loop
        ></video>
        <div class="overlaybutton back" onclick="audioEl().currentTime -= 5"></div>
        <div class="overlaybutton forward" onclick="audioEl().currentTime += 5"></div>
        <div class="overlaybutton middle" onclick="mayToggleFullScreen()"></div>
        <a class="parent-button"
          v-bind:class="{overscan: isTV}"
          v-bind:href="parent"
        >
          <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="position: relative; top: 5px">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 3.1875L21.4501 10.275L21.0001 11.625H20.25V20.25H3.75005V11.625H3.00005L2.55005 10.275L12 3.1875ZM5.25005 10.125V18.75H18.75V10.125L12 5.0625L5.25005 10.125Z" fill="#f7efd2"/>
          </svg>
        </a>
        <audio
          id="audio"
          controls
          v-bind:src="src"
          v-bind:class="{overscan: isTV, audioOnly}"
          autofocus
          autoplay
        ></audio>
        <canvas
          v-if="audioOnly"
          id="waveform"
          width="600"
          height="200"
        ></canvas>
        <span
          v-if="!audioOnly"
          class="close-button"
          v-bind:class="{overscan: isTV}"
          v-on:click="audioOnly = true"
        >&times;</span>
        <span class="name-title" onclick="audioEl()[audioEl().paused ? 'play' : 'pause']()">{{name}}</span>
      </div>
      <script>
        const user = localStorage.getItem('user');
        if (!user) {
          location.pathname = '/login';
        }
        const cookies = document.cookie.split(/;\s*/g).map(x => x.split('=')).reduce((c, [k, v]) => ({...c, [k]: v}), {});
        const { data_key } = cookies;

        const audioEl = () => document.querySelector('audio');
        const searchParams = new URLSearchParams(location.search);
        const videoEl = () => document.querySelector('video');

        const app = new Vue({
          el: '#app',
          data: {
            src: location.hash.slice(1),
            parent: '/' + location.hash.replace(/\/[^\/]+$/, ''),
            name: decodeURIComponent(location.hash.split('/').reverse()[0]).replace(/\.\w+$/, ''),
            isTV: navigator.userAgent.includes('Silk'),
            audioOnly: searchParams.get('audioOnly') === 'true',
          },
          mounted: () => {
            audioEl().addEventListener("loadedmetadata", () => {
              Data.get(data_key + '/' + user + '/times/' + encodeURIComponent(location.hash.replace(/\.\w+$/, '')))
                .then(r => {
                  if (r && r !== 1) {
                    audioEl().currentTime = (r || 0) * audioEl().duration;
                  }
                });
            });
            let updateTimeout;
            audioEl().addEventListener("timeupdate", () => {
              if (!updateTimeout) {
                updateTimeout = setTimeout(() => updateTimeout = 0, 10000);
                updateTimeRemote();
              }
            });
            audioEl().addEventListener('pause', () => {
              updateTimeRemote();
              videoEl().pause();
            });
            audioEl().addEventListener('ended', () => {
              updateTimeRemote();
              const { hash } = location;
              const index = hash.lastIndexOf('/');
              localStorage.setItem('lastData', JSON.stringify({
                name: decodeURIComponent(hash.slice(index + 1)),
                audioOnly: app.audioOnly,
                random: searchParams.get('random') === 'true',
              }));
              location.href = `/${hash.slice(0, index)}`;
            });
            audioEl().addEventListener("play", () => {
              videoEl().play();
            });
            audioEl().addEventListener("seeked", () => {
              randomSeekVideo();
            });
            videoEl().addEventListener("loadedmetadata", () => {
              randomSeekVideo();
              setInterval(randomSeekVideo, 15_000);
            });
          },
        });

        document.title = app.name;

        function handleOnKeyDown(event) {
          let preventDefault = true;
          switch(event.key) {
            case 'ArrowLeft':
              audioEl().currentTime -= 10;
              break;
            case 'ArrowRight':
              audioEl().currentTime += 10;
              break;
            case '0':
              audioEl().currentTime = 0;
              break;
            case 'm':
              audioEl().muted = !audioEl().muted;
              break;
            case 'f':
              toggleFullScreen();
              break;
            case ' ':
              togglePlayback();
              break;
            default:
              console.log(event.key);
              preventDefault = false;
              break;
          }
          if (preventDefault) event.preventDefault();
        }

        function togglePlayback() {
          audioEl()[audioEl().paused ? 'play' : 'pause']();
          navigator.wakeLock.request("screen");
        }
        let clickTimeout;
        function mayToggleFullScreen(event) {
          if (clickTimeout) {
            toggleFullScreen();
            clearTimeout(clickTimeout);
            clickTimeout = 0;
          } else {
            clickTimeout = setTimeout(() => {
              togglePlayback();
              clickTimeout = 0;
            }, 400);
          }
        }
        function toggleFullScreen() {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else {
            audioEl().parentElement.requestFullscreen();
          }
        }
        const seekedToTimes = [];
        function randomSeekVideo() {
          let time;
          for (let i = 0; i < 500; i++) {
            time = videoEl().duration * Math.random();
            if (!seekedToTimes.some(t => time > (t - 15) && time < (t + 15))) {
              break;
            }
            if (i === 499) {
              seekedToTimes.splice(0);
            }
          }
          seekedToTimes.push(time);
          videoEl().currentTime = time;
        }
        function updateTimeRemote() {
          const percentage = audioEl().currentTime / audioEl().duration;
          if (percentage) {
            Data.set(data_key + '/' + user + '/times/' + encodeURIComponent(location.hash.replace(/\.\w+$/, '')), percentage);
          }
        }
        let hoverTimeout;
        function handleMouseMove() {
          clearTimeout(hoverTimeout);
          const el = document.getElementById('app');
          el.classList.add('hovering');
          hoverTimeout = setTimeout(() => el.classList.remove('hovering'), 7000);
        }
      </script>
      <script>
        const audio = document.getElementById('audio');
        const canvas = document.getElementById('waveform');
        const ctx = canvas.getContext('2d');

        // Set canvas width to match window size
        canvas.width = window.innerWidth;

        // Create AudioContext
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        // Create source from audio element
        const source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);

        const bufferLength = analyser.fftSize;
        const dataArray = new Uint8Array(bufferLength);

        function drawWaveform() {
          requestAnimationFrame(drawWaveform);

          analyser.getByteTimeDomainData(dataArray);

          ctx.fillStyle = '#222';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          ctx.lineWidth = 2;
          ctx.strokeStyle = '#00ff00';
          ctx.beginPath();

          const sliceWidth = canvas.width / bufferLength;
          let x = 0;

          for (let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 128.0; // scale 0-1
            const y = (v * canvas.height) / 2;

            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }

            x += sliceWidth;
          }

          ctx.lineTo(canvas.width, canvas.height / 2);
          ctx.stroke();
        }

        // Start visualization when audio is played
        audio.onplay = () => {
          if (audioCtx.state === 'suspended') {
            audioCtx.resume();
          }
          drawWaveform();
        };

        // Resize canvas dynamically
        window.addEventListener('resize', () => {
          canvas.width = window.innerWidth;
        });
      </script>
    </body>
  </html>
