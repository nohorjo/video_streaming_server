<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Video Streaming Server</title>
      <link rel="stylesheet" href="style.css">
      <script src="http://muhammedhaque.co.uk/pages/data-api.js"></script>
      <script src="https://www.youtube.com/iframe_api"></script>
      <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    </head>
    <body onkeydown="handleOnKeyDown(event)">
      <div id="app" onmousemove="handleMouseMove()">
        <div
          v-if="!audioOnly"
          id="player"
        ></div>
        <div class="overlaybutton back" onclick="audioEl().currentTime -= 5"></div>
        <div class="overlaybutton middle" onclick="mayToggleFullScreen()"></div>
        <div class="overlaybutton forward" onclick="audioEl().currentTime += 5"></div>
        <audio
          controls
          v-bind:src="src"
          v-bind:class="{overscan: isTV, audioOnly}"
          autofocus
          autoplay
        ></audio>
        <span
          v-if="!audioOnly"
          class="close-button"
          v-on:click="audioOnly = true; document.getElementById('player').remove()"
        >&times;</span>
        <span class="name-title" onclick="togglePlayback()">{{name}}</span>
      </div>
      <script>
        const user = localStorage.getItem('user');
        if (!user) {
          location.pathname = '/login';
        }

        const audioEl = () => document.querySelector('audio');
        let videoEl;

        const app = new Vue({
          el: '#app',
          data: {
            src: location.hash.slice(1),
            name: decodeURIComponent(location.hash.split('/').reverse()[0]).replace(/\.\w+$/, ''),
            isTV: navigator.userAgent.includes('Silk'),
            audioOnly: new URLSearchParams(location.search).get('audioOnly') === 'true',
          },
          mounted: () => {
            audioEl().addEventListener("loadedmetadata", () => {
              Data.get('videoTime/' + user + '/times/' + encodeURIComponent(location.hash.replace(/\.\w+$/, '')))
                .then(r => {
                  audioEl().currentTime = (r || 0) * audioEl().duration;
                });
            });
            let updateTimeout;
            audioEl().addEventListener("timeupdate", () => {
              if (!updateTimeout) {
                updateTimeout = setTimeout(() => updateTimeout = 0, 10000);
                updateTimeRemote();
              }
            });
            audioEl().addEventListener('pause', () => {
              updateTimeRemote();
              videoEl.pauseVideo();
            });
            audioEl().addEventListener('ended', () => {
              updateTimeRemote();
              const { hash } = location;
              const index = hash.lastIndexOf('/');
              location.href = `/?last=${encodeURIComponent(hash.slice(index + 1))}&audioOnly=${app.audioOnly}${hash.slice(0, index)}`;
            });
            audioEl().addEventListener("play", () => {
              videoEl.playVideo();
            });
            audioEl().addEventListener("seeked", () => {
              randomSeekVideo();
            });
          },
        });

        document.title = app.name;

        function handleOnKeyDown(event) {
          let preventDefault = true;
          switch(event.key) {
            case 'ArrowLeft':
              audioEl().currentTime -= 10;
              break;
            case 'ArrowRight':
              audioEl().currentTime += 10;
              break;
            case '0':
              audioEl().currentTime = 0;
              break;
            case 'm':
              audioEl().muted = !audioEl().muted;
              break;
            case 'f':
              toggleFullScreen();
              break;
            case ' ':
              togglePlayback();
              break;
            default:
              console.log(event.key);
              preventDefault = false;
              break;
          }
          if (preventDefault) event.preventDefault();
        }

        function togglePlayback() {
          audioEl()[audioEl().paused ? 'play' : 'pause']();
        }
        let clickTimeout;
        function mayToggleFullScreen(event) {
          if (clickTimeout) {
            toggleFullScreen();
            clearTimeout(clickTimeout);
            clickTimeout = 0;
          } else {
            clickTimeout = setTimeout(() => {
              togglePlayback();
              clickTimeout = 0;
            }, 400);
          }
        }
        function toggleFullScreen() {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else {
            audioEl().parentElement.requestFullscreen();
          }
          setTimeout(() => {
            videoEl.setSize(window.innerWidth, window.innerHeight)
          }, 200);
        }
        function randomSeekVideo() {
          videoEl.seekTo(videoEl.getDuration() * Math.random());
        }
        function updateTimeRemote() {
          Data.set('videoTime/' + user + '/times/' + encodeURIComponent(location.hash.replace(/\.\w+$/, '')), audioEl().currentTime / audioEl().duration);
        }
        let hoverTimeout;
        function handleMouseMove() {
          clearTimeout(hoverTimeout);
          const el = document.getElementById('app');
          el.classList.add('hovering');
          hoverTimeout = setTimeout(() => el.classList.remove('hovering'), 7000);
        }

        function onYouTubeIframeAPIReady() {
          videoEl = new YT.Player('player', {
            height: window.innerHeight,
            width: window.innerWidth,
            videoId: 'hXoua0T7kQQ',
            playerVars: {
              autoplay: 1,
              controls: 0,
              disablekb: 1,
              enablejsapi: 1,
              fs: 0,
              loop: 1,
              playsinline: 1,
              rel: 0,
              start: Math.random() * 15000,
            },
            events: {
              onReady: () => {
                randomSeekVideo();
                setInterval(randomSeekVideo, 15_000);
                videoEl.playVideo();
              },
              onStateChange: event => {
                switch (event.data) {
                  case YT.PlayerState.PLAYING:
                    audioEl().play();
                    break;
                  case YT.PlayerState.PAUSED:
                    audioEl().pause();
                    break;
                }
              },
            }
          });
        }
      </script>
    </body>
  </html>
